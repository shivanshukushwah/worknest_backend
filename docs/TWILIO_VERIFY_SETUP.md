# Twilio Verify OTP System - Complete Implementation Guide

## Overview
This document describes the production-ready OTP verification system using Twilio Verify service. The OTP is generated and managed entirely by Twilio, ensuring security and compliance.

---

## Setup Instructions

### 1. Get Twilio Verify Service SID

**Steps:**
1. Go to [Twilio Console](https://console.twilio.com)
2. Sign in with your account
3. Navigate to **Verify** → **Services**
4. Click **Create Service** or select existing service
5. Copy the **Service SID** (starts with `VA`)
6. Add to `.env`:
   ```
   TWILIO_VERIFY_SERVICE_SID=VAxxxxxxxxxxxxxxxxxxxxxxxx
   ```

### 2. Environment Variables

Add these to `.env`:

```dotenv
# Twilio Account Credentials
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your_auth_token_here

# Twilio Verify Service
TWILIO_VERIFY_SERVICE_SID=VAxxxxxxxxxxxxxxxxxxxxxxxx

# Environment
NODE_ENV=production  # or development
```

---

## API Endpoints

### 1. Register & Send OTP

**Endpoint:** `POST /api/auth/register`

**Request Body:**
```json
{
  "name": "John Doe",
  "email": "john@example.com",
  "password": "password123",
  "confirmPassword": "password123",
  "role": "student",
  "phone": "+919876543210",
  "location": {
    "city": "Mumbai",
    "state": "Maharashtra",
    "country": "India"
  }
}
```

**Success Response (201):**
```json
{
  "success": true,
  "message": "OTP sent successfully to your mobile number.",
  "userId": "6956ed9430fc410441bb9c26"
}
```

**Important:**
- OTP is **NOT** returned in the response (secure)
- OTP is sent by Twilio to the phone number
- Phone must be in **E.164 format**: `+[country code][number]`
- Examples:
  - India: `+919876543210`
  - US: `+12015550123`
  - UK: `+442071838750`

---

### 2. Verify OTP & Get JWT Token

**Endpoint:** `POST /api/auth/verify-otp`

**Request Body:**
```json
{
  "phone": "+919876543210",
  "otp": "123456"
}
```

**Success Response (200):**
```json
{
  "success": true,
  "message": "Phone verified successfully",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "6956ed9430fc410441bb9c26",
    "name": "John Doe",
    "email": "john@example.com",
    "role": "student",
    "isPhoneVerified": true
  }
}
```

**Error Responses:**
- **400:** Invalid OTP, expired OTP, or too many attempts
- **404:** User not found

---

### 3. Resend OTP

**Endpoint:** `POST /api/auth/resend-otp`

**Request Body:**
```json
{
  "phone": "+919876543210"
}
```

**Success Response (200):**
```json
{
  "success": true,
  "message": "OTP sent successfully to your mobile number."
}
```

**Cooldown:** 60 seconds between OTP requests (rate limiting)

---

## Postman Collection Example

### Register Request
```
POST http://localhost:5000/api/auth/register
Content-Type: application/json

{
  "name": "Test User",
  "email": "test@example.com",
  "password": "Test@123456",
  "confirmPassword": "Test@123456",
  "role": "student",
  "phone": "+919876543210",
  "location": {
    "city": "Mumbai",
    "state": "Maharashtra",
    "country": "India"
  }
}
```

### Verify OTP Request
```
POST http://localhost:5000/api/auth/verify-otp
Content-Type: application/json

{
  "phone": "+919876543210",
  "otp": "123456"
}
```

### Resend OTP Request
```
POST http://localhost:5000/api/auth/resend-otp
Content-Type: application/json

{
  "phone": "+919876543210"
}
```

---

## How It Works

### Registration Flow
```
1. User submits registration form with phone number
   ↓
2. Backend creates user in database (isPhoneVerified = false)
   ↓
3. Backend calls verifyService.sendOtp(phone)
   ↓
4. Twilio generates OTP and sends via SMS
   ↓
5. Backend returns success message (NO OTP exposed)
   ↓
6. User receives SMS with OTP on their phone
```

### OTP Verification Flow
```
1. User submits OTP from SMS
   ↓
2. Backend calls verifyService.verifyOtp(phone, otp)
   ↓
3. Twilio validates the OTP (secure, server-side)
   ↓
4. If valid: Mark user as verified, issue JWT token
   ↓
5. User is now authenticated and can use app
```

---

## Security Features

✅ **OTP Generated by Twilio** - Not manually generated, more secure
✅ **OTP Never Exposed** - Not returned in API responses or logs
✅ **Server-Side Verification** - OTP checked on Twilio servers
✅ **E.164 Phone Format** - International standard for phone numbers
✅ **Rate Limiting** - 60 second cooldown between requests
✅ **Error Handling** - Graceful error messages without exposing internals
✅ **Trial Account Support** - Verified phone numbers in test mode
✅ **Production Ready** - All error cases handled

---

## Error Handling

### Common Errors & Solutions

| Error | Cause | Solution |
|-------|-------|----------|
| "Trial account: add verified numbers" | Using Twilio trial account | Go to Twilio Console → Verify phone number |
| "Account does not have SMS capability" | Account not set up for SMS | Add SMS capability in Twilio Console |
| "Invalid phone number format" | Wrong format (e.g., 919876543210) | Use E.164 format: +919876543210 |
| "OTP has expired" | OTP older than 10 minutes | User should request new OTP |
| "Invalid OTP" | Wrong code entered | User should verify the code from SMS |
| "Twilio Verify not configured" | Missing env variables | Check TWILIO_VERIFY_SERVICE_SID in .env |

---

## Environment Configuration

### Development
```dotenv
NODE_ENV=development
TWILIO_ACCOUNT_SID=your_test_sid
TWILIO_AUTH_TOKEN=your_test_token
TWILIO_VERIFY_SERVICE_SID=your_test_verify_sid
```

### Production
```dotenv
NODE_ENV=production
TWILIO_ACCOUNT_SID=your_production_sid
TWILIO_AUTH_TOKEN=your_production_token
TWILIO_VERIFY_SERVICE_SID=your_production_verify_sid
```

---

## Testing with Twilio (Trial Account)

1. **Upgrade Trial Account** (free to add verified numbers)
   - Go to Twilio Console → Verified Caller IDs
   - Add your phone number
   - Verify by following SMS link

2. **Test OTP Flow**
   - Register with your verified phone number
   - You'll receive an SMS with OTP
   - Use OTP to verify and complete registration

3. **Test Error Cases**
   - Invalid phone: Use `+1234567890`
   - Expired OTP: Wait 10 minutes before verifying
   - Rate limit: Try resend within 60 seconds

---

## Code Structure

**Files Modified/Created:**
- `services/verifyService.js` - Twilio Verify API integration
- `controllers/authController.js` - Updated register, verify-otp, resend-otp
- `.env` - Added Twilio Verify credentials

**Key Functions:**
- `verifyService.sendOtp(phone)` - Send OTP via Twilio
- `verifyService.verifyOtp(phone, code)` - Verify OTP via Twilio

---

## Troubleshooting

### Issue: "SMS provider not configured"
- Check all 3 env variables are set
- Restart server after updating .env
- Verify TWILIO_VERIFY_SERVICE_SID is correct (starts with VA)

### Issue: OTP not received
- Verify phone number format is E.164 (includes + and country code)
- Check phone number is verified in Twilio Console (if trial account)
- Check if Twilio account is on trial vs production

### Issue: Server errors on verify
- Check Twilio credentials are correct
- Ensure OTP hasn't expired (valid for 10 minutes)
- Check logs for exact error message

---

## Best Practices

✅ Always use E.164 format for phone numbers
✅ Don't log OTP or expose in responses
✅ Implement rate limiting (already done: 60s cooldown)
✅ Use HTTPS in production
✅ Validate phone format before sending
✅ Handle Twilio API errors gracefully
✅ Keep credentials in environment variables
✅ Test with verified numbers on trial accounts

---

## Next Steps

1. Get your `TWILIO_VERIFY_SERVICE_SID` from Twilio Console
2. Update `.env` with correct Service SID
3. Restart the server
4. Test with Postman using examples above
5. Verify SMS is received on your phone
6. Complete the OTP verification flow

---

## Support

For Twilio Verify API issues, check:
- [Twilio Verify Documentation](https://www.twilio.com/docs/verify/api)
- [Twilio Console](https://console.twilio.com)
- [Twilio Support](https://support.twilio.com)
